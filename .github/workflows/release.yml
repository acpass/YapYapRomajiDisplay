name: Release Build

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 4.8.x

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Prepare Libs and Rewrite CSPROJ
      shell: pwsh
      run: |
        # Check if Libs folder exists (User should commit this or provide it)
        # For this example, we assume Libs folder needs to be created or populated.
        # Since we cannot commit binaries to git usually, you might need a step to download them or restore them.
        # Here we create the folder to avoid MSBuild errors if empty, but the build will fail if DLLs are missing.
        if (-not (Test-Path "Libs")) {
            mkdir Libs
            Write-Warning "Libs folder created but empty. You must populate it with game DLLs for the build to succeed."
        }
        
        # Rewrite .csproj to use relative ./Libs path instead of local absolute paths
        # This allows the build to run on GitHub Actions without changing your local .csproj permanently
        $projectFile = "YapYapRomaji.csproj"
        $content = Get-Content $projectFile -Raw
        
        # Replace Managed path
        $content = $content -replace 'C:\\Program Files \(x86\)\\Steam\\steamapps\\common\\YAPYAP\\yapyap_Data\\Managed', 'Libs'
        # Replace BepInEx core path
        $content = $content -replace 'C:\\Users\\lyc86\\AppData\\Roaming\\r2modmanPlus-local\\Yapyap\\profiles\\Default\\BepInEx\\core', 'Libs'
        
        Set-Content $projectFile $content
        Write-Host "Updated .csproj to use ./Libs folder for references."

    - name: Extract Version
      id: get_version
      shell: pwsh
      run: |
        $pattern = 'BepInPlugin\(".*", ".*", "(.*)"\)'
        $path = "RomajiDisplay.cs"
        if (Test-Path $path) {
            $content = Get-Content $path -Raw
            if ($content -match $pattern) {
                $version = $matches[1]
                Write-Host "Found version: $version"
                echo "VERSION=$version" >> $env:GITHUB_ENV
            } else {
                Write-Error "Could not find version in $path"
                exit 1
            }
        } else {
            Write-Error "$path not found"
            exit 1
        }

    - name: Build
      run: |
        msbuild YapYapRomaji.csproj /p:Configuration=Release

    - name: Create Zip
      shell: pwsh
      run: |
        $version = $env:VERSION
        $zipName = "acpass-YapYapRomajiDisplay-$version.zip"
        $buildDir = "bin/Release"
        
        if (!(Test-Path "$buildDir/YapYapRomaji.dll")) {
             Write-Error "Build artifact not found at $buildDir/YapYapRomaji.dll"
             exit 1
        }
        
        $files = @(
            "$buildDir/YapYapRomaji.dll",
            "manifest.json",
            "icon.png"
        )
        
        # Verify files exist
        foreach ($f in $files) {
            if (-not (Test-Path $f)) {
                Write-Warning "File not found: $f"
            }
        }

        Compress-Archive -Path $files -DestinationPath $zipName
        echo "ZIP_NAME=$zipName" >> $env:GITHUB_ENV

    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'push'
      with:
        tag_name: v${{ env.VERSION }}
        files: ${{ env.ZIP_NAME }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
